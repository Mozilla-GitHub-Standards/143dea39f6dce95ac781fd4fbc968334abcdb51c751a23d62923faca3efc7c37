version: 1
tasks:
- metadata:
    name: "version-control-tools Tests"
    description: "Builds the test environment and runs tests (without Docker)"
    owner: ${push.owner}
    source: ${repository.url}
  taskId: '${as_slugid("decision")}'
  taskGroupId: '${as_slugid("decision")}'
  schedulerId: '${repository.level}'
  created: {$fromNow: ''}
  deadline: {$fromNow: '1 day'}
  expires: {$fromNow: '1 year 1 second'} # 1 second so artifacts expire first, despite rounding errors
  provisionerId: "aws-provisioner-v1"
  workerType: "version-control-tools"
  scopes: []
  routes:
    - "tc-treeherder.v2.${repository.project}.${push.revision}.${push.pushlog_id}"
  dependencies: []
  requires: all-completed
  retries: 5
  payload:
    env:
      NO_DOCKER: 1
      TMPDIR: /work/tmp
      USER: hg
    image: 'mozvct/vcttest:0.2'
    maxRunTime: 3600
    command:
      - "/bin/bash"
      - "-lc"
      - "mkdir /work/tmp && hg clone ${repository.url} /work/vct && cd /work/vct && hg up ${push.revision} && cp -a /vct/-cache/venv . && ./create-test-environment && ./run-tests --blacklist=testing/exclude_reviewboard.txt --with-hg=venv/mercurials/4.6.2/bin/hg --no-docker --color=never"
  extra:
    treeherder:
      symbol: T
      jobKind: test
      productName: version-control-tools
