version: 1
tasks:
- metadata:
    name: "version-control-tools Tests"
    description: "Builds the test environment and runs tests (without Docker)"
    owner: ${push.owner}
    source: ${repository.url}
  taskId: '${as_slugid("decision")}'
  taskGroupId: '${as_slugid("decision")}'
  schedulerId: '${repository.level}'
  created: {$fromNow: ''}
  deadline: {$fromNow: '1 day'}
  expires: {$fromNow: '1 year 1 second'} # 1 second so artifacts expire first, despite rounding errors
  provisionerId: "aws-provisioner-v1"
  workerType: "version-control-tools"
  scopes: []
  routes:
    - "tc-treeherder.v2.${repository.project}.${push.revision}.${push.pushlog_id}"
  dependencies: []
  requires: all-completed
  retries: 5
  payload:
    env:
      NO_DOCKER: 1
    image: 'ubuntu:18.04'
    maxRunTime: '5 hours'
    command:
      - "/bin/bash"
      - "-lc"
      - "hg clone ${repository.url} v-c-t && cd v-c-t && hg up ${push.revision} && ./create-test-environment && ./run-tests --blacklist=testing/exclude_reviewboard.txt --all-hg-versions --no-hg-tip"
  extra:
    treeherder:
      symbol: T
      jobKind: test
      productName: version-control-tools
